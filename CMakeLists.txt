PROJECT ( llvm_translator )
CMAKE_MINIMUM_REQUIRED ( VERSION 2.8.8 FATAL_ERROR )

SET ( LIBRARY_NAME "llvm_translator" )
SET ( DEFAULT_BUILD_TYPE "Debug" )
SET ( CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${PROJECT_SOURCE_DIR}/cmake" )

FIND_PACKAGE ( LLVM 3.4 REQUIRED )
FIND_PACKAGE ( QEMU )
FIND_PACKAGE ( GLIB REQUIRED )
FIND_PACKAGE ( Curses REQUIRED )


INCLUDE_DIRECTORIES ( include ${QEMU_INCLUDE_DIRECTORIES} ${LLVM_INCLUDE_DIRS} ${GLIB_INCLUDE_DIRS} )
ADD_DEFINITIONS ( -DNEED_CPU_H -D__STDC_CONSTANT_MACROS -D__STDC_LIMIT_MACROS -DCONFIG_LLVM )
SET ( CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,-undefined,dynamic_lookup" )

SET ( LLVM_TRANSLATOR_SRC 
	src/tcg-llvm.cpp
	src/tcg-plugin-main.cpp)
    
MESSAGE ( "QEMU_INCLUDE_DIRECTORIES = ${QEMU_INCLUDE_DIRECTORIES}" )
    
    
#    %.bc: %.c $(GENERATED_HEADERS)
#            $(call quiet-command,$(CC) $(filter-out -g -Wold-style-declaration, $(QEMU_INCLUDES) $(QEMU_CFLAGS) $(QEMU_DGFLAGS) $(CFLAGS)) -c -DS2E_LLVM_LIB -emit-llvm -o $@ $<,"  LLVMCC    $(TARGET_DIR)$@")
	
FOREACH ( QEMU_TARGET ${QEMU_TARGETS} )
    STRING ( REPLACE "," ";" QEMU_TARGET_LIST ${QEMU_TARGET} )
    LIST ( GET QEMU_TARGET_LIST 0 QEMU_BASE_ARCH )
    LIST ( GET QEMU_TARGET_LIST 1 QEMU_TARGET_DIRECTORY )
    LIST ( GET QEMU_TARGET_LIST 2 QEMU_ARCH )
    
    # Build the TCG plugin
	SET ( CURRENT_LIB_NAME ${LIBRARY_NAME}-${QEMU_TARGET_DIRECTORY} )
	
	ADD_LIBRARY ( ${CURRENT_LIB_NAME} SHARED ${LLVM_TRANSLATOR_SRC} )
	TARGET_LINK_LIBRARIES ( ${CURRENT_LIB_NAME} ${LLVM_LIBRARIES} ${CURSES_LIBRARY} )
	SET_PROPERTY ( TARGET ${CURRENT_LIB_NAME} APPEND PROPERTY INCLUDE_DIRECTORIES 
		"${QEMU_SOURCE}/target-${QEMU_BASE_ARCH}" "${QEMU_BUILD}/${QEMU_TARGET_DIRECTORY}" )
	SET_PROPERTY ( TARGET ${CURRENT_LIB_NAME} APPEND PROPERTY COMPILE_FLAGS 
		"-DTARGET_EMULATION_MODE=\\\"${QEMU_TARGET_DIRECTORY}\\\" -DTARGET_NAME=\\\"${QEMU_ARCH}\\\"" ) 
        
    # Build the LLVM helper library
        
ENDFOREACH ( QEMU_TARGET ${QEMU_TARGETS} )